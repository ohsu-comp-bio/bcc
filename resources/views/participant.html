<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script type="text/javascript">


        /* Copyright (c) 2010-2012 LabKey Corporation
         *
         *
         * Licensed under the Apache License, Version 2.0: http://www.apache.org/licenses/LICENSE-2.0
         */

        /**
         * @cfg defaultTab The default top-level tab that will be select on load, if no more specific report is active
         * @cfg defaultReport The default report (2nd tier tab) to show on load.
         * @cfg filterTypes
         * @cfg autoLoadDefaultTab If true, the default tab will automatically load unless another is selected
         * @cfg reportNamespace The namespace where JS reports are located.  If null, it assumes none (i.e. this)
         * @cfg maxSubjectsToShow The maximum number of subject IDs to show as buttons before collapsing into a summary
         * @cfg reports
         */
        Ext4.define('LDK.panel.JFTabbedReportPanel', {
            extend: 'Ext.panel.Panel',
            alias: 'widget.ldk-JFtabbedreportpanel',
            allowEditing: true,
            maxSubjectsToShow: 15,
            showDiscvrLink: true,

            initComponent: function(){
                Ext4.apply(this, {
                    tabsReady: false,
                    border: false,
                    bodyStyle: 'background-color : transparent;margin-bottom: 10px;',
                    reportMap: {},
                    defaults: {
                        border: false
                    },
                    items: [{
                        layout: 'hbox',
                        defaults: {
                            border: false
                        },
                        items: [{
                            xtype: 'panel',
                            defaults: {
                                border: false
                            },
                            items: [{
                                xtype: 'panel',
                                defaults: {
                                    border: false
                                },
                                itemId: 'togglePanel',
                                style: 'margin-bottom:20px;',
                                layout: 'hbox',
                                items: this.getFilterOptionsItems()
                            },{
                                xtype: 'panel',
                                defaults: {
                                    border: false
                                },
                                itemId: 'filterPanel',
                                layout: 'hbox'
                            }]
                        },{
                            itemId: 'idPanel',
                            border: false,
                            defaults: {
                                border: false
                            }
                        }]
                    },{
                        xtype: 'button',
                        border: true,
                        text: 'Refresh',
                        handler: this.onSubmit,
                        forceRefresh: true,
                        itemId: 'submitBtn',
                        disabled: true,
                        scope: this,
                        style:'margin-left:200px;margin-top: 10px;'
                    },{
                        xtype: 'container',
                        items: this.getIEWarning()
                    },{
                        tag: 'span',
                        style: 'padding: 10px'
                    },{
                        xtype: 'tabpanel',
                        itemId: 'tabPanel',
                        listeners: {
                            scope: this,
                            tabchange: this.onCategoryTabChange,
                            afterrender: function (panel) {
                                panel.getTabBar().addCls("category-tab-bar");
                            }
                        }
                    },{
                        hidden: !this.showDiscvrLink,
                        style: 'padding: 5px;padding-top: 0px;text-align: center',
                        html: 'Powered By DISCVR.  <a href="https://github.com/bbimber/discvr/wiki">Click here to learn more.</a>'
                    }]
                });

                this.callParent(arguments);

                this.on('afterrender', this.onAfterRender);
            },

            getIEWarning: function(){
                var toAdd = [];

                if (Ext4.isIE){
                    toAdd.push({
                        border: false,
                        html: '<span>NOTE: You are currently using Internet Explorer.  While this page will work on any browser, it may perform better in other browsers, such as Chrome or Firefox.  For the best experience, we recommend using one of these browsers.</span>',
                        style: 'padding-top: 20px;'
                    });
                }

                return toAdd;
            },

            onAfterRender: function(panel){
                this.originalWidth = this.getWidth();
            },

            onCategoryTabChange: function(panel, tab, oldTab){
                //when we shift top-level tabs, it is possible for a previously loaded report to still show, yet
                //not have the right IDs.  therefore when we change tabs, we force the child to fire tabchange.
                //its listener should only reload if necessary

                //NOTE: if we have a default tab set, it will initially be active.  if we loaded the page with a different
                //top-level tab selected toggling tabs could result in loading that child tab unintentionally.
                //if we toggle to a new top-level tab, but there is no previously loaded child, treat it like no tab is selected
                var childTab = tab.getActiveTab();
                if (oldTab && childTab && !childTab.hasLoaded){
                    tab.setActiveTab(null);
                    childTab = null;
                }

                if (childTab){
                    tab.fireEvent('tabchange', tab, childTab);
                }
            },

            setSubjGrid: function(subjects){
                var target = this.down('#idPanel');
                target.removeAll();

                if (subjects && subjects.length){
                    target.add({
                        itemId: 'totalPanel',
                        html: 'Total IDs: ' + subjects.length
                    });

                    var toAdd = [];
                    for (var i = 0; i < Math.min(this.maxSubjectsToShow, subjects.length); i++){
                        toAdd.push({
                            xtype: 'button',
                            border: true,
                            minWidth: 80,
                            text: subjects[i]+' (X)',
                            subjectID: subjects[i],
                            style: 'margin: 2px;',
                            handler: function(button){
                                var panel = button.up('#buttonPanel');
                                var index = panel.subjectIDs.indexOf(button.subjectID);
                                if(index > -1) {
                                    panel.subjectIDs.splice(index, 1);
                                }

                                button.destroy();

                                var total = panel.items.getCount();
                                var owner = panel.up('panel');
                                var div = owner.down('#totalPanel');
                                div.destroy();
                                owner.insert(0, {
                                    itemId: 'totalPanel',
                                    html: 'Total IDs: ' + total
                                });
                            },
                            scope: this
                        });
                    }

                    if (toAdd.length){
                        target.add({
                            xtype: 'panel',
                            itemId: 'buttonPanel',
                            subjectIDs: subjects,
                            layout: {
                                type: 'table',
                                columns: 5
                            },
                            items: toAdd
                        });
                    }

                    if (subjects.length > this.maxSubjectsToShow) {
                        target.add({
                            xtype: 'panel',
                            border: false,
                            html: '<span class="labkey-error">Plus ' + (subjects.length - this.maxSubjectsToShow)  + ' additional IDs</span>'
                        });
                    }
                }
            },

            getSubjects: function(){
                var panel = this.down('#buttonPanel');
                if (!panel || !panel.items.getCount())
                    return null;

                var subjects = [];

                if (panel.subjectIDs)
                    subjects = subjects.concat(panel.subjectIDs);
                else
                {
                    panel.items.each(function (btn) {
                        if (btn.subjectID)
                            subjects.push(btn.subjectID);
                    }, this);
                }

                return subjects;
            },

            checkValid: function(){
                if (this.activeFilterType)
                    return this.activeFilterType.checkValid();

                return true;
            },

            onSubmit: function(btn){
                if (!this.checkValid())
                    return;

                if (btn)
                    this.forceRefresh = true;

                this.activeReport = null;
                var tabPanel = this.down('#tabPanel');
                var categoryTab = tabPanel.getActiveTab();
                if (categoryTab){
                    var subTab = categoryTab.getActiveTab();
                    if (subTab){
                        this.activeReport = subTab;
                    }
                    else {
                        if (this.defaultReport){
                            var report = this.findReport(this.defaultReport);
                            if (report){
                                var owner = report.up('tabpanel');
                                if (owner == categoryTab){
                                    this.activeReport = report;
                                }
                            }
                        }

                        //if a top-level tab is active, but no 2nd tier tab selected, use the left-most tab
                        if (!this.activeReport && categoryTab){
                            this.activeReport = categoryTab.items.get(0);
                        }
                    }
                }

                if (this.activeReport){
                    var parentTab = this.activeReport.up('tabpanel');
                    tabPanel.setActiveTab(parentTab);
                    parentTab.setActiveTab(this.activeReport);

                    this.loadTab(this.activeReport);
                }
                else {
                    Ext4.Msg.alert('Error', 'You must select a report to display by clicking the one of the 2nd tier tabs below.')
                }
            },

            findReport: function(name){
                var tabPanel = this.down('#tabPanel');
                var panel;
                tabPanel.items.each(function(tab){
                    panel = tab.down('panel[itemId="' + name + '"]');
                    if (panel)
                        return false;
                }, this);

                return panel;
            },

            displayReport: function(tab){
                switch (tab.report.reportType){
                    case 'query':
                        this.loadQuery(tab);
                        break;
                    case 'details':
                        this.loadDetails(tab);
                        break;
                    case 'report':
                        this.loadReport(tab);
                        break;
                    case 'js':
                        this.loadJS(tab);
                        break;
                    default:
                        LDK.Utils.getErrorCallback()({
                            message: 'Improper Report Type'
                        });
                }
            },

            getFilterArray: function(tab){
                var report = tab.report;
                var filterArray = this.activeFilterType.getFilterArray(tab);

                return filterArray;
            },

            getCombinedFilterArray: function(tab){
                var fa = this.getFilterArray(tab);
                var ret = [];
                if (fa && fa.removable){
                    ret = ret.concat(fa.removable);
                }

                if (fa && fa.nonRemovable){
                    ret = ret.concat(fa.nonRemovable);
                }

                return ret;
            },


            getTitleSuffix: function(tab){
                var title = this.activeFilterType.getTitle(tab);
                return title ? ' - ' + title : '';
            },

            loadQuery: function(tab){
                var filterArray = this.getFilterArray(tab);

                if (!this.validateReportForFilterType(tab, filterArray))
                    return;

                var title = this.getTitleSuffix(tab);

                var queryConfig = {
                    title: tab.report.label + title,
                    schemaName: tab.report.schemaName,
                    queryName: tab.report.queryName,
                    suppressRenderErrors: true,
                    allowChooseQuery: false,
                    allowChooseView: true,
                    showInsertNewButton: !!this.allowEditing,
                    showDeleteButton: !!this.allowEditing,
                    showDetailsColumn: true,
                    showUpdateColumn: !!this.allowEditing,
                    showRecordSelectors: true,
                    showReports: false,
                    allowHeaderLock: false, //added b/c locking does not work well inside Ext4 panels
                    tab: tab,
                    frame: 'portal',
                    buttonBarPosition: 'top',
                    timeout: 0,
                    filters: filterArray.nonRemovable,
                    removeableFilters: filterArray.removable,
                    linkTarget: '_blank',
                    success: this.onDataRegionLoad,
                    failure: LDK.Utils.getErrorCallback(),
                    scope: this
                };

                //special case these two properties because they are common
                if (tab.report.viewName){
                    queryConfig.viewName = tab.report.viewName;
                }

                if (tab.report.containerPath){
                    queryConfig.containerPath = tab.report.containerPath;
                }

                //allow any other supported properties to be applied through here
                if (tab.report.queryConfig){
                    Ext4.apply(queryConfig, tab.report.queryConfig);
                }

                tab.add({
                    xtype: 'ldk-querypanel',
                    itemId: 'queryPanel',
                    queryConfig: queryConfig
                });
            },

            onDataRegionLoad: function(dr){
                var itemWidth = Ext4.get(dr.domId).getSize().width + 150;
                this.doResize(itemWidth);
                LABKEY.Utils.signalWebDriverTest("LDK_reportTabLoaded");
            },

            onTabChange: function(tab){
                if (tab.items.getCount()){
                    var item = tab.items.get(0);
                    if (item.onContentSizeChange){
                        item.onContentSizeChange();
                    }

                    var width = item.getWidth();
                    this.doResize(width);
                }
                LABKEY.Utils.signalWebDriverTest("LDK_reportTabLoaded");
            },

            doResize: function(itemWidth){
                var width2 = this.getWidth();
                if (itemWidth > width2){
                    this.setWidth(itemWidth);
                    this.doLayout();
                }
                else if (itemWidth < width2) {
                    if (this.originalWidth && width2 != this.originalWidth){
                        this.setWidth(Math.max(this.originalWidth, itemWidth));
                        this.doLayout();
                    }
                }
            },

            getQWPConfig: function(config){
                var ret = {
                    allowChooseQuery: false,
                    allowChooseView: true,
                    showRecordSelectors: true,
                    suppressRenderErrors: true,
                    allowHeaderLock: false, //added b/c locking does not work well inside Ext4 panels
                    showReports: false,
                    frame: 'portal',
                    linkTarget: '_blank',
                    buttonBarPosition: 'top',
                    timeout: 0,
                    success: this.onDataRegionLoad,
                    failure: LDK.Utils.getErrorCallback(),
                    scope: this,
                    showInsertNewButton: false,
                    showDeleteButton: false,
                    showDetailsColumn: true,
                    showUpdateColumn: false
                };

                if (this.allowEditing){
                    Ext4.apply(ret, {
                        showInsertNewButton: true,
                        showDeleteButton: true,
                        showUpdateColumn: true
                    });
                }

                Ext4.apply(ret, config);

                return ret;
            },

            loadReport: function(tab){
                var filterArray = this.getFilterArray(tab);

                if (!this.validateReportForFilterType(tab, filterArray))
                    return;

                filterArray = filterArray.nonRemovable.concat(filterArray.removable);
                var target = tab.add({
                    xtype: 'ldk-contentresizingpanel',
                    minHeight: 50
                });

                target.mask('Loading...');

                var queryConfig = {
                    partName: 'Report',
                    renderTo: target.renderTarget,
                    suppressRenderErrors: true,
                    partConfig: {
                        title: tab.report.label + this.getTitleSuffix(),
                        schemaName: tab.report.schemaName,
                        reportId : tab.report.reportId,
                        'query.queryName': tab.report.queryName
                    },
                    filters: filterArray,
                    success: function(result){
                        target.unmask();
                        Ext4.defer(target.createListeners, 200, target);
                        LABKEY.Utils.signalWebDriverTest("LDK_reportTabLoaded");
                    },
                    failure: LDK.Utils.getErrorCallback(),
                    scope: this
                };

                if (filterArray.length){
                    Ext4.each(filterArray, function(filter){
                        queryConfig.partConfig[filter.getURLParameterName('query')] = filter.getURLParameterValue();
                    }, this);
                }

                if (tab.report.containerPath){
                    queryConfig.containerPath = tab.report.containerPath;
                }

                if (tab.report.viewName){
                    queryConfig.partConfig.showSection = tab.report.viewName;
                }

                new LABKEY.WebPart(queryConfig).render();
            },

            loadJS: function(tab){
                var jsFunction;
                if (Ext4.isFunction(tab.report.jsHandler)){
                    jsFunction = tab.report.jsHandler;
                }
                else {
                    //NOTE: namespace is only retained for legacy support.  It should be eliminated.
                    var ns = this.reportNamespace;
                    jsFunction = ns ? ns[tab.report.jsHandler] : this[tab.report.jsHandler];
                }

                if (!jsFunction)
                {
                    var message = "Could not find JavaScript function '" + tab.report.jsHandler + "' to load tab in Animal History. The report is misconfigured.";
                    LDK.Utils.logError(message);
                    alert(message);
                }
                else
                {
                    jsFunction(this, tab);
                }
                LABKEY.Utils.signalWebDriverTest("LDK_reportTabLoaded");
            },

            loadDetails: function(tab, target){
                var filterArray = this.getFilterArray(tab);

                if (~this.validateReportForFilterType(tab, filterArray)){
                    return;
                }

                filterArray = filterArray.nonRemovable.concat(filterArray.removable);

                target = tab.add({tag: 'span', html: 'Loading', cls: 'loading-indicator'});

                var config = {
                    schemaName: tab.report.schemaName,
                    queryName: tab.report.queryName,
                    title: tab.report.label + this.getTitleSuffix(),
                    titleField: 'Id',
                    renderTo: target.id,
                    success: function(){
                        LABKEY.Utils.signalWebDriverTest("LDK_reportTabLoaded");
                    },
                    filterArray: filterArray,
                    multiToGrid: this.multiToGrid
                };

                if (tab.report.viewName){
                    config.viewName = tab.report.viewName;
                }

                Ext4.create('LDK.ext.MultiDetailsPanel', config);
            },

            validateReportForFilterType: function(tab, filterArray){
                var message = this.activeFilterType.validateReport(tab.report);
                if (!message) {
                    return true;
                }
                else {
                    tab.removeAll();
                    tab.add({
                        html: message,
                        border: false
                    });

                    return false;
                }
            },

            getFilterOptionsItems: function(){
                var cfg = [{
                    width: 200,
                    html: '<p>Type of Search:</p>'
                },{
                    xtype: 'radiogroup',
                    itemId: 'inputType',
                    labelWidth: 200,
                    defaults: {
                        width: 200
                    },
                    columns: 1,
                    listeners: {
                        scope: this,
                        change: function(field, val){
                            val = val.selector;
                            this.changeFilterType(val);
                        }
                    },
                    items: []
                }];

                Ext4.each(this.filterTypes, function(t, idx){
                    cfg[1].items.push({
                        xtype: 'radio',
                        name: 'selector',
                        inputValue: t.inputValue,
                        checked: idx == 0,
                        boxLabel: t.label,
                        hidden: t.hidden,
                        value: t.initialValue
                    });
                }, this);

                return cfg;
            },

            changeFilterType: function(inputValue){
                var target = this.down('#filterPanel');

                var filterType = this.getFilterType(inputValue);
                if (filterType){
                    var cfg = Ext4.apply({}, filterType);
                    cfg.tabbedReportPanel = this;
                    cfg.filterContext = this.getFilterContext();

                    if (this.activeFilterType){
                        this.activeFilterType.prepareRemove();
                    }
                    target.removeAll();

                    this.activeFilterType = target.add(cfg);
                }

                if (this.loadOnRender || this.autoLoadDefaultTab){
                    this.onSubmit();
                    this.loadOnRender = null;
                    this.autoLoadDefaultTab = null;
                }
            },

            getFilterContext: function(){
                var ctx;
                if (this.activeFilterType){
                    ctx = this.activeFilterType.getFilters();
                }

                ctx = ctx || {};

                if (this.initialContext){
                    Ext4.applyIf(ctx, this.initialContext);
                    this.initialContext = null;
                }

                return ctx;
            },

            getFilterType: function(inputValue){
                var filter;
                Ext4.each(this.filterTypes, function(f){
                    if (f.inputValue == inputValue){
                        filter = f;
                        return false;
                    }
                }, this);

                return filter ? Ext4.apply({}, filter) : null;
            },

            getFiltersFromUrl: function(){
                var context = {};
                if (document.location.hash){
                    var token = document.location.hash.split('#');
                    token = token[1].split('&');

                    for (var i=0;i<token.length;i++){
                        var t = token[i].split(':');
                        switch(t[0]){
                            case 'inputType':
                                context.inputType = t[1];
                                break;
                            case 'showReport':
                                this.loadOnRender = (t[1] == 1);
                                break;
                            case 'activeReport':
                                this.report = t[1];
                                var tab = this.reportMap[t[1]];
                                if (tab){
                                    this.activeReport = tab;
                                    this.silentlySetActiveTab(this.activeReport);
                                }
                                else {
                                    console.error('unable to find tab: ' + t[1])
                                }
                                break;
                            default:
                                context[t[0]] = t[1];
                        }
                    }
                }

                return context;
            },

            createTabPanel: function(){
                var tabPanel = this.down('#tabPanel');

                if (!this.reports || !this.reports.length){
                    tabPanel.add({
                        html: 'There are no reports enabled in this folder.  Please contact your administrator if you believe this is an error.',
                        style: 'padding: 10px;',
                        border: false
                    });
                    return;
                }

                Ext4.each(this.reports, function(report){
                    if (!report || !report.category)
                        return;

                    if (report.visible === false)
                        return;

                    var category = report.category;

                    //create top-level tab
                    if (!tabPanel.down('panel[itemId="' + category + '"]')){
                        tabPanel.add({
                            xtype: 'tabpanel',
                            style: 'margin-bottom: 10px;',
                            itemId: category,
                            title: category,
                            enableTabScroll: true,
                            listeners: {
                                scope: this,
                                tabchange: function(panel, tab, oldTab){
                                    this.activeReport = tab;
                                    this.silentlySetActiveTab(this.activeReport);
                                    //jQuery(".report-tab-bar").removeClass("report-tab-bar");
                                    //panel.getTabBar().addCls("report-tab-bar");
                                    this.onSubmit();
                                },
                                added: function(panel) {
                                    panel.getTabBar().addCls("report-tab-bar");
                                }
                            }
                        });
                    }

                    var subTab = tabPanel.down('panel[itemId="' + category + '"]');
                    var reportId = report.id || report.name;

                    //create 2nd tier tab
                    if (!subTab.down('panel[itemId="' + reportId + '"]')){
                        var theTab = subTab.add({
                            xtype: 'panel',
                            style: 'margin-bottom: 10px;',
                            title: report.label,
                            itemId: reportId,
                            report: report,
                            bodyStyle:'padding:5px',
                            border: false,
                            subjectArray: [],
                            filterArray: {},
                            tbar: {
                                style: 'padding-left:10px'
                            }
                        });

                        if (this.report == reportId){
                            this.activeReport = theTab;
                        }

                        this.reportMap[reportId] = theTab;
                    }
                }, this);

                if (this.activeReport){
                    this.silentlySetActiveTab(this.activeReport);
                }
                else if (this.defaultReport){
                    var report = this.findReport(this.defaultReport);
                    if (report)
                        this.silentlySetActiveTab(report);
                }
                else if (this.defaultTab) {
                    var tab = tabPanel.down('#' + this.defaultTab);
                    tabPanel.suspendEvents();
                    tab.suspendEvents();
                    tabPanel.setActiveTab(tab);
                    tab.resumeEvents();
                    tabPanel.resumeEvents();
                }

                //populate initial fields
                var shouldChange = true;
                this.initialContext = this.getFiltersFromUrl();
                var filterType = this.initialContext.inputType;
                if (filterType){
                    var radio = this.down('#inputType');
                    var val = radio.getValue().selector;

                    radio.setValue({
                        selector: filterType
                    });

                    if (filterType != val)
                        shouldChange = false;
                }

                if (shouldChange) {
                    this.changeFilterType(this.down('#inputType').getValue().selector);
                }

                var submitBtn = this.down('#submitBtn');
                if (submitBtn){
                    this.tabsReady = true;
                    submitBtn.setDisabled(false);
                    LABKEY.Utils.signalWebDriverTest("LDK_reportPanelLoaded");
                }
            },

            createKeyListener: function(el){
                Ext4.create('Ext.util.KeyNav', el, {
                    scope: this,
                    enter: this.onSubmit
                });
            },

            silentlySetActiveTab: function(tab){
                var tabPanel = this.down('#tabPanel');

                tabPanel.suspendEvents();
                tab.suspendEvents();
                tab.ownerCt.suspendEvents();

                tab.ownerCt.setActiveTab(tab);
                tabPanel.setActiveTab(tab.ownerCt);

                tab.resumeEvents();
                tab.ownerCt.resumeEvents();
                tabPanel.resumeEvents();
            },

            loadTab: function(tab){
                var filters = this.getFilters(tab);

                var reload = false;
                if (tab.filters){
                    for (var i in filters){
                        if (JSON.stringify(filters[i]) !== JSON.stringify(tab.filters[i])){
                            reload = true;
                            break;
                        }
                    }
                }
                else {
                    reload = true;
                }

                //indicates tab already has up to date content
                if (reload == false && !this.forceRefresh){
                    this.onTabChange(tab);
                    console.log('no reload needed');
                    return;
                }
                this.forceRefresh = null;

                tab.filters = filters;
                tab.removeAll();

                this.activeReport = tab;
                tab.hasLoaded = true;
                this.hasLoaded = true;
                this.displayReport(tab);
            },

            getFilters: function(tab){
                var filters = this.activeFilterType.getFilters() || {};
                Ext4.apply(filters, {
                    inputType : this.down('#inputType').getValue().selector,
                    showReport: 1,
                    activeReport: tab.report.id
                });

                //set history
                var token = [];
                for (var i in filters){
                    if (filters[i]){
                        // NOTE: requests will fail if the URL is too long.  when trying to filter on a long list of discrete IDs, it can be fairly easy to hit this limit
                        // this solution isnt perfect, but if we simply omit those IDs from the return URL it should succeed.  this will
                        // mean we cannot
                        if (filters[i].length > 200){
                            console.log('param is too long for URL: ' + i + '/' + filters[i].length);
                        }
                        else {
                            token.push(i + ':' + filters[i]);
                        }
                    }
                }
                Ext4.History.add(token.join('&'));

                return filters;
            }
        });


        Ext4.define('LDK.panel.SingleSubjectFilterTypeWithFilters', {
            extend: 'LDK.panel.AbstractFilterType',
            alias: 'widget.ldk-singlesubjectfiltertypewithfilters',

            statics: {
                filterName: 'singleSubject',
                DEFAULT_LABEL: 'Single Subject'
            },

            nounSingular: 'Subject',

            initComponent: function(){
                this.items = this.getItems();

                this.callParent();
            },

            getItems: function(){
                var ctx = this.filterContext;
                var toAdd = [];

                toAdd.push({
                    width: 200,
                    html: 'Enter ' + this.nounSingular + ' Id:',
                    style: 'margin-bottom:10px'
                });

                toAdd.push({
                    xtype: 'panel',
                    items: [{
                        xtype: 'textfield',
                        width: 165,
                        itemId: 'subjArea',
                        value: Ext4.isArray(ctx.subjects) ? ctx.subjects.join(';') : ctx.subjects,
                        listeners: {
                            scope: this,
                            render: function(field){
                                field.keyListener = this.tabbedReportPanel.createKeyListener(field.getEl());
                            }
                        }
                    }]
                });

                return toAdd;
            },

            getFilters: function(){
                return {
                    subjects: this.getSubjects()
                }
            },

            getFilterArray: function(tab, subject){
                var filterArray = {
                    removable: [],
                    nonRemovable: []
                };

                var report = tab.report;
                var subjectFieldName = report.subjectFieldName;
                if (!subjectFieldName){
                    //Ext4.Msg.alert('Error', 'This report does no provide the name of the field holding the subjectId');
                    return;
                }

                var filters = this.getFilters();
                if (filters.subjects && filters.subjects.length){
                    if (filters.subjects.length == 1)
                        filterArray.nonRemovable.push(LABKEY.Filter.create(subjectFieldName, filters.subjects[0], LABKEY.Filter.Types.EQUAL));
                    else
                        filterArray.nonRemovable.push(LABKEY.Filter.create(subjectFieldName, filters.subjects.join(';'), LABKEY.Filter.Types.EQUALS_ONE_OF));
                }

                if(tab.report.additionalFilters){

                    console.log(tab.report.additionalFilters);

                    for (var k =0; k < tab.report.additionalFilters.length; k++){

                        filterArray.nonRemovable.push(tab.report.additionalFilters[k]);
                    }

                }

                return filterArray;
            },

            checkValid: function(){
                var val = this.down('#subjArea').getValue();
                val = Ext4.String.trim(val);
                if(!val){
                    Ext4.Msg.alert('Error', 'Must enter at least one ' + this.nounSingular + ' ID');
                    return false;
                };

                return true;
            },

            validateReport: function(report){
                if (!report.subjectFieldName)
                    return 'This report cannot be used with the selected filter type, because the report does not contain a ' + this.nounSingular + ' Id field';

                return null;
            },

            getTitle: function(){
                var subjects = this.getSubjects();
                if (subjects && subjects.length){
                    if (subjects.length <= 6)
                        return subjects.join(', ');

                    return subjects.slice(0,5).join(', ') + '...';
                }

                return '';
            },

            getSubjects: function(){
                var subjectArray = LDK.Utils.splitIds(this.down('#subjArea').getValue());

                if (subjectArray.length > 0){
                    subjectArray = Ext4.unique(subjectArray);
                    subjectArray.sort();
                }

                return subjectArray;
            }
        });

        var bindUI = function(ctrl, data){

            ctrl = $(ctrl);

            ctrl.find("[visibility]").hide();

            if(!data) {
                return;
            }

            for(var attribIdx in data){


                if(data[attribIdx] != null){

                    ctrl.find("[visibility='" + attribIdx + "']").show();

                    ctrl.find("[data='" + attribIdx + "']").each(function(){
                        $(this).html( ($(this).html() + " " +  data[attribIdx]).trim());

                    });
                }

            }
        };

        var toggleGraphVisibility = function(show){

            if(show){
                $("[whenVisible]").show();
                $("[whenNotVisible]").hide();
            } else {

                $("[whenVisible]").hide();
                $("[whenNotVisible]").show();
            }

        };

        $(document).ready(function(){
            toggleGraphVisibility(true);
        });


        function getReportConfig(queryName, schemaName, category, title, viewName){

            var result = {
                id: queryName,
                name: queryName,
                category: category,
                schemaName: schemaName,
                queryName: queryName,
                label: title || queryName,
                reportType: 'query',
                subjectFieldName: LABKEY.getModuleProperty('Study', 'subject').columnName,
                dateFieldName: 'date'
            };

            if(viewName){
                result.viewName = viewName;
                result.id = result.id + '_' + viewName;
                result.name = result.name + '_' + viewName;
            }

            return result;
        };



        Ext4.onReady(function (){
            /* get the participant id from the request URL: this parameter is required. */
            var participantId = LABKEY.ActionURL.getParameter('participantId') || LABKEY.ActionURL.getParameter('patientId');
            if (!participantId){
                alert('Must Provide Id');
                return;
            }

            var summaryDiv =  jQuery('#patientSummary');
            var narativeDiv = jQuery('#narriative');
            bindUI(summaryDiv);
            bindUI(narativeDiv);

            LABKEY.Query.selectRows({
                schemaName : "study",
                queryName : "demographics",
                filterArray : [
                    LABKEY.Filter.create("OPTR",participantId)
                ],
                success : function(data) {

                    populatePatientSummary(data.rows[0],summaryDiv);

                },
                error : function(errorInfo, options, responseObj) {

                }
            });

            LABKEY.Query.selectRows({
                schemaName : "lists",
                queryName : "tumorboardpatient",
                sort : "tumorboardID-",
                filterArray : [
                        LABKEY.Filter.create("OPTR",participantId)
                ],
                success : function(data){

                            console.log(data);
                    populateClinicalNarative(data.rows[0],narativeDiv);
                }
            });



            var populateClinicalNarative= function(nariativeRow, ctrl){

                bindUI(ctrl,nariativeRow)

            }

            var populatePatientSummary = function(patientRow, ctrl) {


                //console.log(patientRow);

                switch(patientRow["Gender"])
                {
                    case "M":
                        patientRow["GenderName"] = "Male";
                        break;

                    case "F":
                        patientRow["GenderName"]="Female";
                        break;
                }

                patientRow["Age"] = calculateAge( patientRow["Date Of Birth"],patientRow["Date Of Death"]);


                bindUI(ctrl,patientRow);
            };


            var tables_to_plot =
                    [
                        "Demographics",
                        "Diagnosis",
                        "Biopsy",
                        "BloodDraw",
                        "Imaging",
                        "Treatments",
                        "Radiotherapy",
                        "OtherTreatments",
                        "CA199",
                        "TumorSize"
                    ];

            plotOPTR(tables_to_plot, participantId, "summaryGraph");

            var title = 'Patient Details: ' + participantId;
            document.title = title;

            var configReports_NonClinical = function(reports){

                reports.push(

                        getReportConfig('Mutation Summary', 'study', 'Genomics', 'Mutation Summary', 'patient_data_browser'),
                        getReportConfig('WES Results', 'study', 'Genomics', 'Somatic Mutations', 'patient_data_browser'),
                        getReportConfig('Germline Variants', 'study', 'Genomics', 'Germline Variants', 'patient_data_browser'),
                        getReportConfig('Gene Trails Results', 'study', 'Genomics', 'Gene Trails Results', 'patient_data_browser')

                );
            }


            LABKEY.Query.selectRows({
                schemaName : "study",
                queryName : "datasets",
                sort : "displayorder",
                filterArray : [
                    LABKEY.Filter.create("categoryid",2)
                ],
                success : function(data){

                    console.log(data);

                    var reports = [];

                    for(var i =0; i< data.rows.length; i++){

                        var dataSet = data.rows[i];

                        //reports.push(getReportConfig(dataSet.Name, 'study', 'Clinical', dataSet.Label));
                        // CRP - Should we check if there is a 'patient_data_browser' for this table first?
                        reports.push(getReportConfig(dataSet.Name, 'study', 'Clinical', dataSet.Label, 'patient_data_browser'));
                    }


                    LABKEY.Query.selectRows({
                        schemaName: "lists",
                        queryName: "ImageType",
                        sort: "DisplayOrderID",
                        filterArray: [
                            LABKEY.Filter.create("PatientOverviewTab", null, LABKEY.Filter.Types.DOES_NOT_HAVE_MISSING_VALUE),
                            LABKEY.Filter.create("PatientOverviewSubTab", null, LABKEY.Filter.Types.DOES_NOT_HAVE_MISSING_VALUE)
                        ],
                        success: function (data) {

                            var filterDefs = [];

                            for (var j = 0; j < data.rows.length; j++)
                            {
                                var imageType = data.rows[j];
                                var key = imageType.PatientOverviewTab + '_' + imageType.PatientOverviewSubTab;
                                if (!filterDefs[key])
                                {

                                    filterDefs[key] = {
                                        tabName: imageType.PatientOverviewTab,
                                        subTabName: imageType.PatientOverviewSubTab,
                                        filter: []
                                    }
                                }

                                filterDefs[key].filter.push(imageType.ImageTypeID);
                            }

                            for (var fdKey in filterDefs)
                            {

                                var cfg = getReportConfig('omeroImages', 'study', filterDefs[fdKey].tabName, filterDefs[fdKey].subTabName,'omeroImages_PatientView');

                                cfg.id = cfg.id + '_' + fdKey;
                                cfg.name = cfg.name + '_' + fdKey;
                                cfg.additionalFilters = [LABKEY.Filter.create("ImageTypeID", filterDefs[fdKey].filter.join(";"), LABKEY.Filter.Types.EQUALS_ONE_OF)];

                                reports.push(cfg);
                            }


                            configReports_NonClinical(reports);

                            //Obtain the tumor board attached documents
                            LABKEY.Query.selectRows({
                                schemaName: "lists",
                                queryName: "TumorBoardDocumentType",
                                sort: "DisplayOrderID",
                                filterArray: [
                                    LABKEY.Filter.create("PatientOverviewTab", null, LABKEY.Filter.Types.DOES_NOT_HAVE_MISSING_VALUE),
                                    LABKEY.Filter.create("PatientOverviewSubTab", null, LABKEY.Filter.Types.DOES_NOT_HAVE_MISSING_VALUE)
                                ],
                                success: function (data)
                                {


                                    var filterDefs = [];

                                    for (var j = 0; j < data.rows.length; j++)
                                    {
                                        var docType = data.rows[j];
                                        var key = docType.PatientOverviewTab + '_' + docType.PatientOverviewSubTab;
                                        if (!filterDefs[key])
                                        {

                                            filterDefs[key] = {
                                                tabName: docType.PatientOverviewTab,
                                                subTabName: docType.PatientOverviewSubTab,
                                                filter: [docType.DocumentTypeID]
                                            }
                                        }
                                        filterDefs[key].filter.push(docType.DocumentTypeID);
                                    }

                                    console.log(filterDefs);
                                    for (var fdKey in filterDefs)
                                    {

                                        var cfg = getReportConfig('TumorBoardDocuments', 'lists', filterDefs[fdKey].tabName, filterDefs[fdKey].subTabName,'patient_data_browser');

                                        cfg.id = cfg.id + '_' + fdKey;
                                        cfg.name = cfg.name + '_' + fdKey;
                                        cfg.additionalFilters = [LABKEY.Filter.create("DocumentType", filterDefs[fdKey].filter.join(";"), LABKEY.Filter.Types.EQUALS_ONE_OF)];

                                        reports.push(cfg);
                                    }


                                    Ext4.define('bcc.panel.TabbedReportPanel', {
                                        extend: 'LDK.panel.JFTabbedReportPanel',

                                        jfcreateTabPanel: function ()
                                        {

                                            var tabPanel = this.down('#tabPanel');

                                            if (!this.reports || !this.reports.length)
                                            {
                                                tabPanel.add({
                                                    html: 'There are no reports enabled in this folder.  Please contact your administrator if you believe this is an error.',
                                                    style: 'padding: 10px;',
                                                    border: false
                                                });
                                                return;
                                            }

                                            Ext4.each(this.reports, function (report)
                                            {
                                                if (!report || !report.category)
                                                    return;

                                                if (report.visible === false)
                                                    return;

                                                var category = report.category;

                                                //create top-level tab
                                                if (!tabPanel.down('panel[itemId="' + category + '"]'))
                                                {
                                                    tabPanel.add({
                                                        xtype: 'tabpanel',
                                                        style: 'margin-bottom: 10px;',
                                                        itemId: category,
                                                        title: category,
                                                        enableTabScroll: true,
                                                        listeners: {
                                                            scope: this,
                                                            tabchange: function (panel, tab, oldTab)
                                                            {
                                                                this.activeReport = tab;
                                                                this.silentlySetActiveTab(this.activeReport);
                                                                //jQuery(".report-tab-bar").removeClass("report-tab-bar");
                                                                //panel.getTabBar().addCls("report-tab-bar");
                                                                this.onSubmit();
                                                            },
                                                            added: function (panel)
                                                            {
                                                                panel.getTabBar().addCls("report-tab-bar");
                                                            }
                                                        }
                                                    });
                                                }

                                                var subTab = tabPanel.down('panel[itemId="' + category + '"]');
                                                var reportId = report.id || report.name;

                                                //create 2nd tier tab
                                                if (!subTab.down('panel[itemId="' + reportId + '"]'))
                                                {
                                                    var theTab = subTab.add({
                                                        xtype: 'panel',
                                                        style: 'margin-bottom: 10px;',
                                                        title: report.label,
                                                        itemId: reportId,
                                                        report: report,
                                                        bodyStyle: 'padding:5px;',
                                                        border: false,
                                                        subjectArray: [],
                                                        filterArray: {},
                                                        tbar: {
                                                            style: 'padding-left:10px'
                                                        }
                                                    });

                                                    if (this.report == reportId)
                                                    {
                                                        this.activeReport = theTab;
                                                    }

                                                    this.reportMap[reportId] = theTab;
                                                }
                                            }, this);

                                            if (this.activeReport)
                                            {
                                                this.silentlySetActiveTab(this.activeReport);
                                            }
                                            else if (this.defaultReport)
                                            {
                                                var report = this.findReport(this.defaultReport);
                                                if (report)
                                                    this.silentlySetActiveTab(report);
                                            }
                                            else if (this.defaultTab)
                                            {
                                                var tab = tabPanel.down('#' + this.defaultTab);
                                                tabPanel.suspendEvents();
                                                tab.suspendEvents();
                                                tabPanel.setActiveTab(tab);
                                                tab.resumeEvents();
                                                tabPanel.resumeEvents();
                                            }

                                            //populate initial fields
                                            var shouldChange = true;
                                            this.initialContext = this.getFiltersFromUrl();
                                            var filterType = this.initialContext.inputType;
                                            if (filterType)
                                            {
                                                var radio = this.down('#inputType');
                                                var val = radio.getValue().selector;

                                                radio.setValue({
                                                    selector: filterType
                                                });

                                                if (filterType != val)
                                                    shouldChange = false;
                                            }

                                            if (shouldChange)
                                            {
                                                this.changeFilterType(this.down('#inputType').getValue().selector);
                                            }

                                            var submitBtn = this.down('#submitBtn');
                                            if (submitBtn)
                                            {
                                                this.tabsReady = true;
                                                submitBtn.setDisabled(false);
                                                LABKEY.Utils.signalWebDriverTest("LDK_reportPanelLoaded");
                                            }
                                        },


                                        initComponent: function ()
                                        {
                                            Ext4.ns('bcc.tabbedReports');

                                            Ext4.apply(this, {
                                                participantId: participantId,
                                                reportNamespace: bcc.tabbedReports
                                            });

                                            this.callParent();

                                            this.down('#submitBtn').hidden = true;
                                            this.loadReports();
                                        },

                                        getFilterOptionsItems: function ()
                                        {
                                            var items = this.callParent();
                                            items[0].hidden = true;
                                            items[1].hidden = true;

                                            return items;
                                        },


                                        loadReports: function ()
                                        {

                                            this.reports = reports;
                                            this.jfcreateTabPanel();
                                        },

                                        filterTypes: [{
                                            //                                    xtype: 'ldk-singlesubjectfiltertype',
                                            //                                    inputValue: LDK.panel.SingleSubjectFilterType.filterName,

                                            xtype: 'ldk-singlesubjectfiltertypewithfilters',
                                            inputValue: LDK.panel.SingleSubjectFilterTypeWithFilters.filterName,


                                            label: 'Single Participant',
                                            hidden: true,
                                            filterContext: {
                                                subjects: [participantId]
                                            },
                                            getSubjects: function ()
                                            {
                                                return [participantId];
                                            },
                                            checkValid: function ()
                                            {
                                                return true;
                                            }
                                        }],


                                        getSimpleXYPlot: function (queryName, schemaName, category, title, plotConfig)
                                        {
                                            if (!plotConfig || !plotConfig.x || !plotConfig.y)
                                            {
                                                Ext4.Msg.alert('Error', 'Must provide the plotConfig and X/Y field names');
                                                return;
                                            }

                                            return {
                                                id: 'plot-' + queryName,
                                                name: queryName,
                                                category: category,
                                                schemaName: schemaName,
                                                queryName: queryName,
                                                label: title,
                                                reportType: 'js',
                                                subjectFieldName: LABKEY.getModuleProperty('Study', 'subject').columnName,
                                                dateFieldName: 'date',
                                                plotConfig: plotConfig,
                                                jsHandler: function (tabPanel, tab)
                                                {
                                                    var filterArray = tabPanel.getCombinedFilterArray(tab);

                                                    LABKEY.Query.selectRows({
                                                        schemaName: tab.report.schemaName,
                                                        queryName: tab.report.queryName,
                                                        filterArray: filterArray,
                                                        scope: this,
                                                        failure: LDK.Utils.getErrorCallback(),
                                                        success: function (results)
                                                        {
                                                            console.log(results);
                                                            var x = [];
                                                            var y = [];

                                                            LDK.ConvertUtils.parseDatesInSelectRowsResults(results);

                                                            Ext4.Array.forEach(results.rows, function (row)
                                                            {
                                                                if (Ext4.isDefined(row[tab.report.plotConfig.x]) && Ext4.isDefined(row[tab.report.plotConfig.y]))
                                                                {
                                                                    x.push(row[tab.report.plotConfig.x]);
                                                                    y.push(row[tab.report.plotConfig.y]);
                                                                }
                                                            }, this);

                                                            if (!results.rows.length)
                                                            {
                                                                tab.add({
                                                                    html: 'No records found',
                                                                    border: false
                                                                });
                                                            }
                                                            else
                                                            {
                                                                tab.add(Ext4.create('LDK.panel.ContentResizingPanel', {
                                                                    plotConfig: tab.report.plotConfig,
                                                                    width: '100%',
                                                                    minHeight: 50,
                                                                    border: false,
                                                                    listeners: {
                                                                        scope: this,
                                                                        afterRender: function (panel)
                                                                        {
                                                                            var data = [{
                                                                                x: x,
                                                                                y: y,
                                                                                mode: 'lines+markers',
                                                                                type: 'scatter'
                                                                            }];

                                                                            Plotly.plot(panel.renderTarget, data, {
                                                                                title: panel.plotConfig.title,
                                                                                //autosize: false,
                                                                                //width: '100%', //why not working?
                                                                                displayModeBar: true,
                                                                                xaxis: {
                                                                                    type: 'date',
                                                                                    tickformat: '%x',
                                                                                    //tickmode: 'auto',
                                                                                    ticks: 'outside',
                                                                                    tickwidth: 1,
                                                                                    tickangle: 40,
                                                                                    ticklen: 5,
                                                                                    showticklabels: true,
                                                                                    showline: false,
                                                                                    showgrid: true,
                                                                                    autorange: true
                                                                                },
                                                                                yaxis: {
                                                                                    showgrid: true
                                                                                }
                                                                            });
                                                                        }
                                                                    }
                                                                }));
                                                            }
                                                        }
                                                    });
                                                }
                                            };
                                        }
                                    });

                                    Ext4.create('bcc.panel.TabbedReportPanel').render('participantDiv');


                                }
                            });
                        }
                    });
                }
            });

        });
    </script>

    <style type="text/css">

        #patientOverview{
            width:100%;
            table-layout: fixed;
            background-color: white;
            border-collapse: collapse;
        }

        #patientOverview td {
            vertical-align: top;
        }

        #summaryGraph{
            height:600px;
        }

        #narriative{
            padding:10px;
            vertical-align: top;
            text-align: left;
            background-color: white;
            max-height: 580px;
            overflow: hidden;
            overflow-y:auto;
            border-left: solid 1px #808080;
        }

        #patientSummary  td{
            vertical-align: top;
            padding:2px;
        }

        #patientSummary  td.left{
            text-align: left;
        }

        #patientSummary  td.right{
            text-align: right;
        }





        #patientSummary h3, #patientSummary h2{
            padding: 0;
            margin:0;
            -webkit-margin-after:0;
            -webkit-margin-before: 0;

        }

        #dataDetails {

        }




    </style>

</head>

<body>


<table id="patientOverview">
    <colgroup>
        <col span="1" style=""/>
        <col span="1" style="width:10px;"/>
        <col span="1" style="width:300px;"/>
    </colgroup>
    <thead>


    </thead>
    <tbody>
        <tr id="patientSummary">
            <td class="left">
                <div>
                    <h2 style="display:inline; padding-right:5px;" visiblility="OPTR" data="OPTR">OPTR: </h2>

                    <span visibility="Date Of Death">Deceased</span>
                    <span visibility="Age">
                            <span data="Age"></span>
                            year-old
                        </span>
                    <span visibility="GenderName" data="GenderName"/>

                </div>

            </td>
            <td/>
            <td class="right">
                <div style="padding:10px;">
                    <a href="javascript: toggleGraphVisibility(true);" style="display:inline;" whenNotVisible>show overview</a>
                    <a href="javascript: toggleGraphVisibility(false);" style="display:inline;" whenVisible>hide overview</a>
                </div>
            </td>
        </tr>
        <tr whenVisible>
            <td>
                <div id="summaryGraph">

                </div>
            </td>
            <td/>
            <td>
                <div id="narriative">
                    <div visiblility="ClinicalNarrativeHTML" data="ClinicalNarrativeHTML"></div>
                </div>
            </td>
        </tr>
        <tr>
           <td colspan="3" id="participantDiv">
           </td>
        </tr>
    </tbody>
</table>
</body>



